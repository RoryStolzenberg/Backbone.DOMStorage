/**
 * Backbone localStorage and sessionStorage Adapter
 * https://github.com/mikeedwards/Backbone.DOMStorage
 */(function(){function c(){return((1+Math.random())*65536|0).toString(16).substring(1)}function d(){return c()+c()+"-"+c()+"-"+c()+"-"+c()+"-"+c()+c()+c()}var a=this._,b=this.Backbone;b.LocalStorage=window.Store=function(a){this.name=a;var b=this.localStorage().getItem(this.name)||"";this.records=b&&b.split(",")||[]},a.extend(b.LocalStorage.prototype,{save:function(){this.localStorage().setItem(this.name,this.records.join(","))},safeGet:function(a){var b=this.localStorage().getItem(a);return b?b:"{}"},create:function(a){return a.id||(a.id=d(),a.set(a.idAttribute,a.id)),this.localStorage().setItem(this.name+"-"+a.id,JSON.stringify(a)),this.records.push(a.id.toString()),this.save(),a.toJSON()},update:function(b){return this.localStorage().setItem(this.name+"-"+b.id,JSON.stringify(b)),a.include(this.records,b.id.toString())||this.records.push(b.id.toString()),this.save(),b.toJSON()},find:function(a){return JSON.parse(this.safeGet(this.name+"-"+a.id))},findAll:function(){return a(this.records).chain().map(function(b){var c=JSON.parse(this.safeGet(this.name+"-"+b));return a.isEmpty(c)?!1:c},this).compact().value()},destroy:function(b){return this.localStorage().removeItem(this.name+"-"+b.id),this.records=a.reject(this.records,function(a){return a==b.id.toString()}),this.save(),b},localStorage:function(){return localStorage}}),b.LocalStorage.sync=window.Store.sync=b.localSync=function(a,b,c,d){var e=b.localStorage||b.collection.localStorage,f,g=$.Deferred&&$.Deferred();typeof c=="function"&&(c={success:c,error:d});switch(a){case"read":f=b.id!=undefined?e.find(b):e.findAll();break;case"create":f=e.create(b);break;case"update":f=e.update(b);break;case"delete":f=e.destroy(b)}return f?(c.success(f),g&&g.resolve()):(c.error("Record not found"),g&&g.reject()),g&&g.promise()},b.SessionStorage=window.SessionStore=function(a){this.name=a;var b=this.sessionStorage().getItem(this.name)||"";this.records=b&&b.split(",")||[]},a.extend(b.SessionStorage.prototype,{save:function(){this.sessionStorage().setItem(this.name,this.records.join(","))},safeGet:function(a){var b=this.sessionStorage().getItem(a);return b?b:"{}"},create:function(a){return a.id||(a.id=d(),a.set(a.idAttribute,a.id)),this.sessionStorage().setItem(this.name+"-"+a.id,JSON.stringify(a)),this.records.push(a.id.toString()),this.save(),a.toJSON()},update:function(b){return this.sessionStorage().setItem(this.name+"-"+b.id,JSON.stringify(b)),a.include(this.records,b.id.toString())||this.records.push(b.id.toString()),this.save(),b.toJSON()},find:function(a){return JSON.parse(this.safeGet(this.name+"-"+a.id))},findAll:function(){return a(this.records).chain().map(function(b){var c=JSON.parse(this.safeGet(this.name+"-"+b));return a.isEmpty(c)?!1:c},this).compact().value()},destroy:function(b){return this.sessionStorage().removeItem(this.name+"-"+b.id),this.records=a.reject(this.records,function(a){return a==b.id.toString()}),this.save(),b},sessionStorage:function(){return sessionStorage}}),b.SessionStorage.sync=b.sessionSync=function(a,b,c,d){var e=b.sessionStorage||b.collection.sessionStorage;typeof c=="function"&&(c={success:c,error:d});var f;switch(a){case"read":f=b.id!=undefined?e.find(b):e.findAll();break;case"create":f=e.create(b);break;case"update":f=e.update(b);break;case"delete":f=e.destroy(b)}f?c.success(f):c.error("Record not found")},b.ajaxSync=b.sync,b.getSyncMethod=function(a){return a.localStorage||a.collection&&a.collection.localStorage?b.localSync:a.sessionStorage||a.collection&&a.collection.sessionStorage?b.SessionStorage.sync:b.ajaxSync},b.sync=function(a,c,d,e){return b.getSyncMethod(c).apply(this,[a,c,d,e])}})();